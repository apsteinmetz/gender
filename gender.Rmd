---
title: "Gender Diversity in R vs Python"
output: html_notebook
---

Guidance on gender of Chinese names: http://blog.tutorming.com/mandarin-chinese-learning-tips/difference-chinese-male-and-female-names-gender

```{r}
library(tidyverse)
library(purrr)
library(jsonlite)
library(rvest)
library(installr)
library(data.table) #for downloading CRAN/RStudio logs
library(httr)
library(gh)

source(file="download_RStudio_CRAN_data.R") 
```

Use the cranlogs api from RStudio to get top package downloads from their CRAN mirror.

```{r get_top_R_packages}
# ----------------------------------------------------------------
#select 5 random days from the last six months
# Read data from RStudio site
RStudio_CRAN_dir <- download_RStudio_CRAN_data(START = Sys.Date()-180,END = Sys.Date(),sample=5)
# read .gz compressed files form local directory
RStudio_CRAN_data <- read_RStudio_CRAN_data(RStudio_CRAN_dir)
 
dim(RStudio_CRAN_data)

# Find the most downloaded packages
r_pkg_list <- most_downloaded_packages(RStudio_CRAN_data,n=100) %>% 
  as_tibble(.name_repair = make.names,c("downloads")) %>% 
  rename(package=X)

save(r_pkg_list,file="data/r_pkg_list.rdata")
```

Source for top 100 Python packages over the last year: https://hugovk.github.io/top-pypi-packages/
Get json (how helpful!).

```{r get_top_python_packages}
py_pkgs_raw<-read_json("https://hugovk.github.io/top-pypi-packages/top-pypi-packages-365-days.json",
                       simplifyVector = TRUE)
python_pkg_list <- py_pkgs_raw$rows[1:100,] %>% 
  as_tibble() %>% 
  rename(package=project,downloads=download_count)
save(python_pkg_list,file="data/python_pkg_list.rdata")

```

Build functions to get contributors to packages and then the real names of those contributors.
Search for relevant repo with just repo name, no user.

https://api.github.com/search/repositories?q=dplyr%20is:name+language:r&sort=stars&order=desc

will return:
      "full_name": "tidyverse/dplyr",

use that to get contributors:

Contributor url: https://api.github.com/repos/tidyverse/dplyr/contributors

will return all contributors with the JSON form:
   "url": "https://api.github.com/users/romainfrancois",

and that will return:
   "name": "Romain François",


```{r get_package_contributors}
library(dplyr)
library(jsonlite)

#this would actually be a list of multiple repos
repo_name <- "rlang"
language <- "r"

my_gh <- function(end_point) {
    return(jsonlite::fromJSON(jsonlite::toJSON(gh::gh(end_point)),simplifyVector = T))
}

# --------------------------------------------------------------------------------
get_contrib_info <- function(repo_name,language="r"){
  base_url <- "https://api.github.com"
  print(repo_name)
  # we don't know the github username associated with the package to construct a search
  # to get the most likely candidate
  search_url <- paste0("/search/repositories?q=",
                       repo_name,
                       ".%20is:name+language:",
                       language,
                       "&sort=stars&order=desc")
  
  
  # first api call.  would need to would need to loop/map/apply over 
  # multiple contributors repo names
  all_repos<-jsonlite::read_json(search_url,simplifyVector = TRUE)
  
  # get full path for exact match on repo name
  regex_str <- paste0(".+/",repo_name,"$")
  target_repo<-all_repos$items %>% 
    filter(str_detect(full_name,regex_str)) %>% 
    pull(full_name) %>% head(1)
  # no error checking if repo is not found
  print(target_repo)
  
  # there might be more than one user with repo of the same name
  # Since they will be in order of download count, take just the first one
  search_url <- paste0("https://api.github.com/repos/",
                       target_repo[1],
                       "/contributors")
  #second api call
  contributors <- jsonlite::read_json(search_url,simplifyVector = TRUE) %>% 
    select(login,url,avatar_url)
  
  #third api call. would need to loop/map/apply over multiple contributors
  get_name <- function(contrib_url){
    return(jsonlite::read_json(contrib_url)$name)
  }
  
  contrib_names<-map(contributors$url,get_name) %>% unlist()
  
  print(paste(length(contrib_names," contributors")))
  
  contrib_info <- tibble(language=language,
                         package=repo_name,
                         path=target_repo,
                         contributor=contrib_names) %>% 
    bind_cols(contributors) %>% 
    select(-url)
  
  
  return(contrib_info)
}

# --------------------------------------------------------------------
get_contrib_info_gh <- function(repo_name,language="r"){
  print(repo_name)
  # we don't know the github username associated with the package to construct a search
  # to get the most likely candidate
  search_url <- paste0("/search/repositories?q=",
                       repo_name,
                       ".%20is:name+language:",
                       language,
                       "&sort=stars&order=desc")
  
  
  # first api call.  would need to would need to loop/map/apply over 
  # multiple contributors repo names
  all_repos <- my_gh(search_url) %>% .$items %>% .$full_name %>% unlist()
  
  # get full path for exact match on repo name
  regex_str <- paste0(".+/",repo_name,"$")
  target_repo <- all_repos[str_detect(all_repos,regex_str)][1]
  # no error checking if repo is not found
  print(target_repo)
  
  # there might be more than one user with repo of the same name
  # Since they will be in order of download count, take just the first one
  search_url <- paste0("/repos/",
                       target_repo,
                       "/contributors")
  #second api call
  contributors <- my_gh(search_url)
  %>% bind_rows() %>%   
    select(login,url,avatar_url)

    #third api call. would need to loop/map/apply over multiple contributors
  # need to strip base url
  get_name <- function(contrib_url){
    return(my_gh(contrib_url)$name)
  }
  
  contrib_names<-map(contributors$url,get_name) %>% unlist()
  
  print(paste(length(contrib_names," contributors")))
  
  contrib_info <- tibble(language=language,
                         package=repo_name,
                         path=target_repo,
                         contributor=contrib_names) %>% 
    bind_cols(contributors) %>% 
    select(-url)
  
  
  return(contrib_info)
}
```


```{r}
load("data/r_pkg_list.rdata")
load("data/python_pkg_list.rdata")

dummy<- function(repo_name,language){
  return(tibble(package=repo_name,language=language,stuff=1:3))
}
dat <- map(r_pkg_list$package,get_contrib_info,language="r") %>% bind_rows()
```

